<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Basement Time | Streaming</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'netflix-red': '#E50914',
                        'netflix-dark': '#0f0f0f',
                        'netflix-medium': '#1c1c1c',
                        'netflix-light': '#2c2c2c',
                    }
                }
            }
        }
    </script>
    <script type="module">
        import { createIcons, MonitorPlay, Film, Tv, ChevronLeft, ChevronRight, Search, Loader } from 'https://unpkg.com/lucide@latest';
        createIcons({ icons: { MonitorPlay, Film, Tv, ChevronLeft, ChevronRight, Search, Loader } });
        window.MonitorPlay = MonitorPlay;
        window.Film = Film;
        window.Tv = Tv;
        window.Loader = Loader;
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0f0f0f; color: #e4e4e7; margin: 0; overflow: hidden; }
        #main-content-area { height: calc(100vh - 4rem); display: flex; }
        #content-list-container { overflow-y: auto; height: 100%; flex-grow: 1; scroll-behavior: smooth; }
        #content-list-container::-webkit-scrollbar { width: 4px; }
        #content-list-container::-webkit-scrollbar-thumb { background-color: #e50914; border-radius: 10px; }
        .player-iframe { height: 500px; max-width: 100%; transition: all 0.5s ease; border: 1px solid #333; }
        .theater-iframe-stretch { height: 80vh !important; border: none !important; border-radius: 0 !important; }
        .full-immersion-right { padding: 0 !important; background: black !important; }
        #season-selector, #episode-selector, #source-selector-1, #genre-filter, #year-filter {
            background-color: #1c1c1c; border: 1px solid #444; color: #fff; border-radius: 6px;
        }
        .overlay-controls {
            position: absolute; bottom: 2rem; left: 50%; transform: translateX(-50%);
            z-index: 50; opacity: 0; pointer-events: none; transition: opacity 0.3s ease;
            background: rgba(15, 15, 15, 0.95); padding: 1rem; border-radius: 1rem;
            border: 1px solid #e50914; width: 90%; max-width: 800px;
        }
        .overlay-visible { opacity: 1; pointer-events: auto; }
        .scroll-indicator { z-index: 30; cursor: pointer; opacity: 0; pointer-events: none; transition: opacity 0.3s; }
        .scroll-indicator.visible { opacity: 1; pointer-events: auto; }
        @media (max-width: 768px) {
            #main-content-area { flex-direction: column; overflow-y: auto; }
            #left-panel { width: 100% !important; height: 50vh; }
            .player-iframe { height: 250px; }
        }
    </style>
</head>
<body class="min-h-screen">

    <header class="h-16 bg-netflix-medium flex items-center px-6 shadow-2xl z-50 sticky top-0 border-b border-netflix-red/30">
        <h1 class="text-2xl font-black text-netflix-red tracking-tighter">BASEMENT TIME</h1>
        <div id="status-container" class="flex-grow flex items-center justify-center px-4">
            <span id="player-status-text" class="text-sm sm:text-lg font-medium text-gray-300 truncate italic">
                Ready to stream...
            </span>
        </div>
        <div class="hidden sm:block text-xs font-bold text-gray-500 uppercase tracking-widest">Premium Access</div>
    </header>

    <div id="main-content-area">
        <div id="left-panel" class="w-[30%] min-w-[350px] bg-netflix-medium flex flex-col border-r border-white/5 transition-all duration-500 ease-in-out">
            <div class="p-4 space-y-4 shadow-lg bg-netflix-medium/50 backdrop-blur-md">
                <div class="flex bg-black rounded-lg p-1 border border-white/10">
                    <button data-type="movie" class="content-toggle-btn flex-grow py-2 text-xs font-bold rounded-md transition bg-netflix-red text-white">MOVIES</button>
                    <button data-type="tv" class="content-toggle-btn flex-grow py-2 text-xs font-bold rounded-md transition text-gray-400 hover:text-white">TV SHOWS</button>
                </div>
                <div class="flex gap-2">
                    <select id="genre-filter" class="w-1/2 p-2 text-xs"></select>
                    <select id="year-filter" class="w-1/2 p-2 text-xs"></select>
                </div>
                <div class="relative">
                    <input type="text" id="content-search" placeholder="Search titles..." class="w-full p-3 pl-10 bg-black border border-white/10 rounded-lg text-sm focus:border-netflix-red outline-none transition">
                    <i data-lucide="search" class="w-4 h-4 text-gray-500 absolute left-3 top-1/2 -translate-y-1/2"></i>
                </div>
            </div>

            <div id="list-wrapper" class="relative flex-grow overflow-hidden">
                <div id="scroll-up-indicator" class="scroll-indicator absolute top-0 inset-x-0 h-8 bg-gradient-to-b from-netflix-medium to-transparent flex justify-center items-start text-netflix-red">▲</div>
                <div id="content-list-container" class="p-4 space-y-4">
                    <div id="content-list" class="space-y-4"></div>
                </div>
                <div id="scroll-down-indicator" class="scroll-indicator absolute bottom-0 inset-x-0 h-8 bg-gradient-to-t from-netflix-medium to-transparent flex justify-center items-end text-netflix-red">▼</div>
            </div>
        </div>

        <div id="right-panel" class="flex-grow bg-netflix-dark p-6 flex flex-col transition-all duration-500 overflow-y-auto">
            <div id="player-area-1" class="relative w-full max-w-6xl mx-auto rounded-xl overflow-hidden shadow-2xl bg-black">
                <div id="player-message-overlay" class="absolute inset-0 z-10 bg-black flex flex-col items-center justify-center text-center p-6">
                    <i data-lucide="monitor-play" class="w-16 h-16 text-netflix-red mb-4 opacity-50"></i>
                    <h2 class="text-xl font-bold">Waiting for selection...</h2>
                </div>
                
                <iframe id="stream-player-1" class="player-iframe w-full bg-black" src="" frameborder="0" allowfullscreen sandbox="allow-same-origin allow-scripts"></iframe>

                <div id="stream-controls-1" class="flex flex-wrap items-center justify-between gap-4 mt-4 bg-netflix-medium p-4 rounded-xl border border-white/5">
                    <div class="flex items-center gap-3">
                        <span class="text-xs font-bold text-gray-500 uppercase">Source</span>
                        <select id="source-selector-1" class="text-sm px-3 py-1.5 focus:ring-1 ring-netflix-red outline-none"></select>
                    </div>

                    <div id="tv-controls" class="flex items-center gap-2" style="display: none;">
                        <button id="prev-episode-btn" class="p-2 hover:bg-white/10 rounded-full transition"><i data-lucide="chevron-left"></i></button>
                        <select id="season-selector" class="text-sm px-2 py-1"></select>
                        <select id="episode-selector" class="text-sm px-2 py-1"></select>
                        <button id="next-episode-btn" class="p-2 hover:bg-white/10 rounded-full transition"><i data-lucide="chevron-right"></i></button>
                    </div>

                    <button id="toggle-theater-mode-btn" onclick="toggleTheaterMode()" class="px-6 py-2 bg-netflix-red text-white text-xs font-black rounded-md hover:scale-105 transition active:scale-95">THEATER MODE</button>
                </div>
            </div>
        </div>
    </div>

    <div id="modal" class="fixed inset-0 bg-black/90 flex items-center justify-center z-[100] opacity-0 pointer-events-none transition-all">
        <div class="bg-netflix-medium p-8 rounded-2xl border border-netflix-red max-w-sm text-center">
            <h3 id="modal-title" class="text-2xl font-bold text-netflix-red mb-2">Notice</h3>
            <p id="modal-message" class="text-gray-400 mb-6"></p>
            <button onclick="hideModal()" class="w-full py-3 bg-netflix-red text-white font-bold rounded-lg">DISMISS</button>
        </div>
    </div>

    <script>
        // --- LOGIC & KEYS PRESERVED ---
        const TMDB_API_KEY = '1070730380f5fee0d87cf0382670b255';
        const TMDB_BASE_URL = 'https://api.themoviedb.org/3';
        const IMAGE_BASE_URL = 'https://image.tmdb.org/t/p/w500';
        const FALLBACK_POSTER_URL = 'https://placehold.co/100x150/1c1c1c/999999?text=No+Poster';
        
        const availableSources = [
            { id: 'wplayme', name: 'Wplay.me', urls: { movie: 'https://embed.wplay.me/embed/movie/{id}', tv: 'https://embed.wplay.me/embed/tv/{id}/{season}/{episode}' } },
            { id: 'primewire', name: 'Primewire', urls: { movie: 'https://www.primewire.tf/embed/movie?tmdb={id}', tv: 'https://www.primewire.tf/embed/tv?tmdb={id}&season={season}&episode={episode}&server=fileLions' } },
            { id: 'vidpop', name: 'Vidpop', urls: { movie: 'https://www.vidpop.xyz/embed/?id={id}', tv: 'https://www.vidpop.xyz/embed/?id={id}&season={season}&episode={episode}' } },
            { id: 'vidsrcpk', name: 'VidSrcPk', urls: { movie: 'https://vidsrc.win/movie/?id={id}', tv: 'https://vidsrc.win/tv.html?id={id}&season={season}&episode={episode}' } },
            { id: 'rive', name: 'RiveStream', urls: { movie: 'https://rivestream.org/embed?type=movie&id={id}', tv: 'https://rivestream.org/embed?type=tv&id={id}&season={season}&episode={episode}' } },
            { id: 'vidnest', name: 'VidNest', urls: { movie: 'https://vidnest.fun/movie/{id}', tv: 'https://vidnest.fun/tv/{id}/{season}/{episode}' } },
            { id: 'bludclart', name: 'Bludclart', urls: { movie: 'https://watch.bludclart.com/movie/{id}', tv: 'https://www.vidking.net/embed/tv/{id}/{season}/{episode}' } },
            { id: 'hexa', name: 'Hexa', urls: { movie: 'https://hexa.watch/watch/movie/{id}', tv: 'https://hexa.watch/watch/tv/{id}/{season}/{episode}' } },
            { id: 'vidzee', name: 'VidZee', urls: { movie: 'https://player.vidzee.wtf/embed/movie/{id}', tv: 'https://player.vidzee.wtf/embed/tv/{id}/{season}/{episode}' } },
            { id: 'vidify', name: 'Vidify', urls: { movie: 'https://vidify.top/embed/movie/{id}', tv: 'https://vidify.top/embed/tv/{id}/{season}/{episode}' } },
            { id: 'spenflix', name: 'SpenFlix', urls: { movie: 'https://spencerdevs.xyz/movie/{id}', tv: 'https://spencerdevs.xyz/tv/{id}/{season}/{episode}' } },
            { id: 'pstream', name: 'P-Stream', urls: { movie: 'https://iframe.pstream.org/embed/tmdb-movie-{id}', tv: 'https://iframe.pstream.org/embed/tmdb-tv-{id}/{season}/{episode}' } }
        ];

        let allContent = [], selectedContent = null, tvDetails = null, isTheaterMode = false, currentContentTypeFilter = 'movie', cachedGenres = { movie: null, tv: null };

        const contentListContainerEl = document.getElementById('content-list-container');
        const contentSearchEl = document.getElementById('content-search');
        const contentListEl = document.getElementById('content-list');
        const rightPanelEl = document.getElementById('right-panel');
        const playerArea1El = document.getElementById('player-area-1');
        const player1Iframe = document.getElementById('stream-player-1');
        const playerMessageOverlayEl = document.getElementById('player-message-overlay');
        const playerStatusTextEl = document.getElementById('player-status-text'); 
        const streamControls1El = document.getElementById('stream-controls-1');
        const sourceSelector1El = document.getElementById('source-selector-1');
        const theaterBtn = document.getElementById('toggle-theater-mode-btn');
        const genreFilterEl = document.getElementById('genre-filter'); 
        const yearFilterEl = document.getElementById('year-filter');   
        const tvControlsEl = document.getElementById('tv-controls');
        const seasonSelectorEl = document.getElementById('season-selector');
        const episodeSelectorEl = document.getElementById('episode-selector');
        const nextEpisodeBtn = document.getElementById('next-episode-btn');
        const prevEpisodeBtn = document.getElementById('prev-episode-btn');
        const leftPanelEl = document.getElementById('left-panel');
        const scrollUpIndicatorEl = document.getElementById('scroll-up-indicator');
        const scrollDownIndicatorEl = document.getElementById('scroll-down-indicator');

        function showModal(title, message) {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-message').textContent = message;
            document.getElementById('modal').classList.remove('opacity-0', 'pointer-events-none');
        }
        function hideModal() { document.getElementById('modal').classList.add('opacity-0', 'pointer-events-none'); }

        async function safeFetch(url) {
            try {
                const response = await fetch(url);
                return await response.json();
            } catch (error) { return null; }
        }

        function getPlayerUrl(sourceId, tmdbId, contentType, season = 1, episode = 1) {
            const source = availableSources.find(s => s.id === sourceId);
            if (!source) return '';
            let template = contentType === 'movie' ? source.urls.movie : source.urls.tv;
            return template.replace('{id}', tmdbId).replace('{season}', season).replace('{episode}', episode);
        }
        
        function loadStreamIntoPlayer(streamUrl, playerIframe) {
            if (streamUrl) {
                playerMessageOverlayEl.style.display = 'none';
                playerIframe.src = streamUrl;
            } else {
                playerMessageOverlayEl.style.display = 'flex';
                playerIframe.src = ''; 
            }
        }

        async function updatePlayerFromSelection() {
            if (!selectedContent) return;
            const sourceId = sourceSelector1El.value;
            const contentType = selectedContent.media_type || currentContentTypeFilter;
            const tmdbId = selectedContent.id;
            let finalUrl = '', epData = null;

            if (contentType === 'tv') {
                const s = seasonSelectorEl.value || 1, e = episodeSelectorEl.value || 1;
                epData = await safeFetch(`${TMDB_BASE_URL}/tv/${tmdbId}/season/${s}/episode/${e}?api_key=${TMDB_API_KEY}`);
                finalUrl = getPlayerUrl(sourceId, tmdbId, contentType, s, e);
                playerStatusTextEl.textContent = `${selectedContent.name || selectedContent.title} - S${s} E${e} ${epData?.name ? ': ' + epData.name : ''}`;
            } else {
                finalUrl = getPlayerUrl(sourceId, tmdbId, contentType);
                playerStatusTextEl.textContent = `Streaming: ${selectedContent.title || selectedContent.name}`;
            }
            loadStreamIntoPlayer(finalUrl, player1Iframe);
        }

        function updateEpisodeSelector() {
            episodeSelectorEl.innerHTML = '';
            const sNum = parseInt(seasonSelectorEl.value);
            const season = tvDetails?.seasons?.find(s => s.season_number === sNum);
            if (season) {
                for (let i = 1; i <= season.episode_count; i++) {
                    const opt = document.createElement('option');
                    opt.value = i; opt.textContent = `Ep ${i}`;
                    episodeSelectorEl.appendChild(opt);
                }
            }
            updatePlayerFromSelection();
        }

        function updateSeasonSelector() {
            seasonSelectorEl.innerHTML = '';
            const valid = tvDetails?.seasons?.filter(s => s.season_number > 0 && s.episode_count > 0) || [];
            valid.forEach(s => {
                const opt = document.createElement('option');
                opt.value = s.season_number; opt.textContent = `Season ${s.season_number}`;
                seasonSelectorEl.appendChild(opt);
            });
            seasonSelectorEl.onchange = updateEpisodeSelector;
            updateEpisodeSelector();
        }

        async function loadContentDetails(content) {
            selectedContent = content;
            const type = content.media_type || currentContentTypeFilter;
            streamControls1El.style.display = 'flex';
            if (type === 'tv') {
                tvDetails = await safeFetch(`${TMDB_BASE_URL}/tv/${content.id}?api_key=${TMDB_API_KEY}`);
                tvControlsEl.style.display = 'flex';
                updateSeasonSelector();
            } else {
                tvControlsEl.style.display = 'none';
                updatePlayerFromSelection();
            }
        }

        function renderContent(items) {
            contentListEl.innerHTML = '';
            items.forEach(item => {
                const div = document.createElement('div');
                div.className = "content-item group cursor-pointer bg-netflix-dark/50 p-2 rounded-lg border border-white/5 hover:border-netflix-red transition flex gap-3";
                const poster = item.poster_path ? IMAGE_BASE_URL + item.poster_path : FALLBACK_POSTER_URL;
                div.innerHTML = `
                    <img src="${poster}" class="w-16 h-24 object-cover rounded shadow-md group-hover:scale-105 transition">
                    <div class="flex-grow min-w-0 flex flex-col justify-center">
                        <h4 class="font-bold text-sm truncate text-white">${item.title || item.name}</h4>
                        <p class="text-[10px] text-gray-500 line-clamp-2 mt-1">${item.overview || ''}</p>
                        <div class="mt-2 flex items-center gap-2">
                            <span class="text-[10px] font-black text-netflix-red">${(item.vote_average || 0).toFixed(1)} ★</span>
                            <span class="text-[10px] text-gray-600">${(item.release_date || item.first_air_date || '').split('-')[0]}</span>
                        </div>
                    </div>
                `;
                div.onclick = () => {
                    document.querySelectorAll('.content-item').forEach(i => i.classList.remove('border-netflix-red'));
                    div.classList.add('border-netflix-red');
                    loadContentDetails(item);
                };
                contentListEl.appendChild(div);
            });
            updateScrollIndicators();
        }

        async function fetchContent() {
            const type = currentContentTypeFilter, q = contentSearchEl.value.trim(), g = genreFilterEl.value, y = yearFilterEl.value;
            let url = q ? `${TMDB_BASE_URL}/search/${type}` : `${TMDB_BASE_URL}/discover/${type}`;
            let params = `?api_key=${TMDB_API_KEY}&language=en-US&page=1`;
            if (q) params += `&query=${encodeURIComponent(q)}`;
            else {
                if (g) {
                    const foundG = cachedGenres[type].find(x => x.name === g);
                    if (foundG) params += `&with_genres=${foundG.id}`;
                }
                if (y) params += type === 'movie' ? `&primary_release_year=${y}` : `&first_air_date_year=${y}`;
                params += '&sort_by=popularity.desc';
            }
            const data = await safeFetch(url + params);
            renderContent(data?.results || []);
        }

        function toggleTheaterMode() {
            isTheaterMode = !isTheaterMode;
            if (isTheaterMode) {
                leftPanelEl.style.width = '0px';
                leftPanelEl.style.minWidth = '0px';
                rightPanelEl.classList.add('full-immersion-right');
                player1Iframe.classList.add('theater-iframe-stretch');
                streamControls1El.classList.add('overlay-controls');
                theaterBtn.textContent = "EXIT THEATER";
                playerArea1El.onmouseenter = () => streamControls1El.classList.add('overlay-visible');
                playerArea1El.onmouseleave = () => streamControls1El.classList.remove('overlay-visible');
            } else {
                leftPanelEl.style.width = '30%';
                leftPanelEl.style.minWidth = '350px';
                rightPanelEl.classList.remove('full-immersion-right');
                player1Iframe.classList.remove('theater-iframe-stretch');
                streamControls1El.classList.remove('overlay-controls', 'overlay-visible');
                theaterBtn.textContent = "THEATER MODE";
                playerArea1El.onmouseenter = null;
                playerArea1El.onmouseleave = null;
            }
        }

        function updateScrollIndicators() {
            const { scrollTop, scrollHeight, clientHeight } = contentListContainerEl;
            scrollUpIndicatorEl.classList.toggle('visible', scrollTop > 10);
            scrollDownIndicatorEl.classList.toggle('visible', scrollHeight - scrollTop - clientHeight > 10);
        }

        window.onload = async () => {
            availableSources.forEach(s => {
                const opt = document.createElement('option');
                opt.value = s.id; opt.textContent = s.name;
                sourceSelector1El.appendChild(opt);
            });
            sourceSelector1El.onchange = updatePlayerFromSelection;

            const currentY = new Date().getFullYear();
            yearFilterEl.innerHTML = '<option value="">Year</option>';
            for(let i=0; i<30; i++) {
                const opt = document.createElement('option');
                opt.value = currentY - i; opt.textContent = currentY - i;
                yearFilterEl.appendChild(opt);
            }

            const mg = await safeFetch(`${TMDB_BASE_URL}/genre/movie/list?api_key=${TMDB_API_KEY}`);
            const tg = await safeFetch(`${TMDB_BASE_URL}/genre/tv/list?api_key=${TMDB_API_KEY}`);
            cachedGenres.movie = mg?.genres; cachedGenres.tv = tg?.genres;
            
            genreFilterEl.innerHTML = '<option value="">Genre</option>';
            [...new Set([...(mg?.genres||[]), ...(tg?.genres||[])].map(x=>x.name))].sort().forEach(n => {
                const opt = document.createElement('option');
                opt.value = n; opt.textContent = n;
                genreFilterEl.appendChild(opt);
            });

            document.querySelectorAll('.content-toggle-btn').forEach(btn => {
                btn.onclick = () => {
                    document.querySelectorAll('.content-toggle-btn').forEach(b => b.className = "content-toggle-btn flex-grow py-2 text-xs font-bold rounded-md transition text-gray-400 hover:text-white");
                    btn.className = "content-toggle-btn flex-grow py-2 text-xs font-bold rounded-md transition bg-netflix-red text-white";
                    currentContentTypeFilter = btn.dataset.type;
                    fetchContent();
                };
            });

            contentSearchEl.oninput = fetchContent;
            genreFilterEl.onchange = fetchContent;
            yearFilterEl.onchange = fetchContent;
            contentListContainerEl.onscroll = updateScrollIndicators;
            
            nextEpisodeBtn.onclick = () => { episodeSelectorEl.selectedIndex++; updateEpisodeSelector(); };
            prevEpisodeBtn.onclick = () => { episodeSelectorEl.selectedIndex--; updateEpisodeSelector(); };

            fetchContent();
        };
    </script>
</body>
</html>
